---
title: "Flight Data Tutorial"
output: html_document
---

## R Markdown

```{r}
library(dplyr)
library(ggplot2)
library(gdata)
library(lubridate)
library(broom)
library(ROCR)
library(caret)
```


```{r}

flight_data <- read.csv("2004.csv.bz2")
```

```{r}
flight_data_jan <- flight_data %>% 
  filter(Month == 1) 
  
```

```{r}
flight_data_test <- read.xls ("FlightDelays.xls", sheet = 1, header = TRUE)
```

```{r}
#dont need this for the Flightdelays.xls sheet

#flight_data_test <- flight_data_test %>%
  #mutate(is_delayed = if_else(ArrDelay > 0, 1, 0))
  
  
```




```{r}
g <- ggplot(flight_data_test, aes(Flight.Status, fill= Flight.Status)) +
  geom_bar() +
  xlab("Flight Status") +
  ylab("Number of Flights")

g
```


```{r}
summary(flight_data_test$Flight.Status)
```

```{r}
summary(flight_data_test$CARRIER)
```

```{r}
#Plot out percentage of delays by airline
flight_data_test %>%
  group_by(CARRIER)%>%
  summarise( n = n()) %>%
  mutate(freq = round(n / sum(n), 2))
```



```{r}

#Plot out percentage of delays by day of week
day_of_week <- flight_data_test %>%
  group_by(DAY_WEEK, Flight.Status)%>%
  summarise( n = n()) %>%
  mutate(freq = n / sum(n))
  
day_of_week$Flight.Status <- relevel(day_of_week$Flight.Status, 'ontime')



ggplot(data= day_of_week, aes(x=DAY_WEEK, y=freq, fill=Flight.Status)) +
  geom_bar(stat="identity")
```

```{r}

#Plot out percentage of delays by airport destination

destination_airport <- flight_data_test %>%
  group_by(DEST, Flight.Status)%>%
  summarise( n = n()) %>%
  mutate(freq = n / sum(n))

destination_airport$Flight.Status <- relevel(destination_airport$Flight.Status, 'ontime')

ggplot(data= destination_airport, aes(x=DEST, y=freq, fill=Flight.Status)) +
  geom_bar(stat="identity")
```




```{r}

#Plot out percentage of delays by airport origin

origin_airport <- flight_data_test %>%
  group_by(ORIGIN, Flight.Status)%>%
  summarise( n = n()) %>%
  mutate(freq = n / sum(n))



origin_airport$Flight.Status <- relevel(origin_airport$Flight.Status, 'ontime')

ggplot(data= origin_airport
       
       , aes(x=ORIGIN, y=freq, fill=Flight.Status)) +
  geom_bar(stat="identity")
```

-----

#make dummy variables of categorical data

```{r}
flight_data_test$DAY_WEEK <- as.factor(flight_data_test$DAY_WEEK)
flights.dummy <- model.matrix(~CARRIER+DEST+ORIGIN+DAY_WEEK,data=flight_data_test)
flights.dummy <- flights.dummy[,-1]
```


#group by each hour

```{r}

flight_data_test$hour <- floor(flight_data_test$DEP_TIME/100)

flight_data_test$hour <- as.factor(flight_data_test$hour)


```


```{r}

flights.dummy1 <- model.matrix(~hour, data=flight_data_test)
flights.dummy1 <- flights.dummy1[,-1]

```

#Join it together


```{r}
flight_data_test_all <- as.data.frame(cbind(flights.dummy, flights.dummy1))


flight_data_test_all$Weather <- flight_data_test$Weather
flight_data_test_all$FlightStatus <- flight_data_test$Flight.Status

```

#Split test and train

```{r}



train_index <- createDataPartition(flight_data_test_all$FlightStatus, p=0.6, list=FALSE)

training <- flight_data_test_all[ train_index, ]
testing <- flight_data_test_all[ -train_index, ]

mod_fit_one <- glm(FlightStatus ~ ., data=training, family="binomial")


summary(mod_fit_one) # estimates 
exp(coef(mod_fit_one)) # odds ratios


testing$prediction <- predict(mod_fit_one, newdata=testing, type="response") # predicted probabilities



testing$predict <- factor(ifelse(testing$prediction >= 0.52389118, "delayed", "ontime"))


#set positive class to ontime, and draw the confusion matrix 
confusionMatrix(data = testing$predict, reference = testing$FlightStatus, positive = levels(testing$FlightStatus)[1])
```






```{r}

pred <- prediction( testing$prediction, testing$FlightStatus, label.ordering = c("delayed", "ontime"))
perf <- performance(pred,"tpr","fpr")
plot(perf)
abline(a=0, b= 1)


#print out area under the curve

#perf <- performance(pred, "auc")
#print(perf@y.values[[1]])


cutoffs <- data.frame(cut=perf@alpha.values[[1]], fpr=perf@x.values[[1]], 
                      tpr=perf@y.values[[1]])



```

```{r}

#make the confusion matrix for train data


test$predict <- predict(model, type="response", newdata = test)

confusionMatrix(test$FlightStatus,if_else(test$predict > 0.5, "ontime", "delayed"))



pred <- prediction(  test$predict,  test$FlightStatus)
perf <- performance(pred,"tpr","fpr")
plot(perf)
abline(a=0, b= 1)

```

```{r}

```

